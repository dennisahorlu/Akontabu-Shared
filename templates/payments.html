<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKONTABU - Payments</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}"> -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .payment-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .nav-bar {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .nav-links {
            display: flex;
            justify-content: space-around;
        }
        .nav-link {
            text-decoration: none;
            color: #333;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        .nav-link:hover {
            background: #f0f0f0;
        }
        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .payment-form {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }
        
        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .submit-btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        
        .payment-list {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .payment-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .payment-table th, 
        .payment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .payment-category {
            margin-top: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .edit-btn {
            background: #2196F3;
            color: white;
        }
        .delete-btn {
            background: #f44336;
            color: white;
        }
       
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="nav-bar">
            <div class="nav-links">
                <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('sales') }}" class="nav-link">Sales</a>
                <a href="{{ url_for('inventory') }}" class="nav-link">Inventory</a>
                <a href="{{ url_for('payments') }}" class="nav-link">Payments</a>
                <a href="{{ url_for('reports') }}" class="nav-link">Reports</a>
                <a href="{{ url_for('settings') }}" class="nav-link">Settings</a>
            </div>
        </div>

        <div class="payment-grid">
            <div class="payment-form">
                <h2>Record New Payment</h2>
                <form id="payment-form" onsubmit="PaymentForm(event)">
                    <div class="form-group">
                        <label for="payment_type">Payment Type</label>
                         <select id="payment_type" name="payment_type" required>
                            <option value="">Select payment type</option>
                            <option value="product">Product Purchase</option>
                            <option value="rent">Rent</option>
                            <option value="utility">Utility</option>
                            <option value="other">Other Payment</option>
                        </select> 
                    </div>

                     <!-- Product Purchase Fields (shown when product is selected) -->
                     <div id="product-fields" class="payment-category" style="display: none;"> 
                         <div class="form-group">
                            <label for="product_name">Product</label>
                            <input type="text" id="product_name" name="product_name" placeholder="Enter product name" required />
                        </div>
                        <div class="form-group">
                            <label for="product_quantity">Quantity</label>
                            <input type="number" id="product_quantity" name="quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="total_cost">Base Cost</label>
                            <input type="number" id="base_cost" name="base_cost" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="transportation">Transportation</label>
                            <input type="number" id="transportation" name="transportation" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="carriage">Carriage</label>
                            <input type="number" id="carriage" name="carriage" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="profit_margin">Profit Margin (%)</label>
                            <input type="number" id="profit_margin" name="profit_margin" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="calculated_price">Calculated Selling Price (per unit)</label>
                            <input type="number" id="calculated_price" name="calculated_price" step="0.01" readonly>
                        </div>

                    </div> 

                    <!-- Other Payment Fields -->
                    <div id="other-fields" class="payment-category" style="display: none;">
                        <div class="form-group">
                            <label for="amount">Amount</label>
                            <input type="number" id="amount" name="amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input type="text" id="description" name="description">
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">Record Payment</button>
                </form>
            </div> 

            <div class="payment-list">
                <h2>Payment History</h2>
                <table class="payment-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Selling Price</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for payment in payments %}
                        <tr>
                            <td>{{ payment.date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ payment.payment_type }}</td>
                            <td>{{ payment.description }}</td>
                            <td>{{ payment.product_name if payment.payment_type == 'product' else 'NA' }}</td>
                            <td>{{ payment.quantity if payment.payment_type == 'product' else 'NA' }}</td>
                            <td>
                                {% if payment.payment_type == 'product' %}
                                    {{ payment.selling_price|currency }}
                                {% endif %}
                            </td>
                            <td>{{ payment.amount|currency }}</td>
                            <td>
                                <input type="hidden" id="edit_payment_id" name="edit_payment_id">
                                <button onclick="editPayment('{{ payment.id }}')" class="action-btn edit-btn">Edit</button>
                                <button onclick="deletePayment('{{ payment.id }}')" class="action-btn delete-btn">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', function () {

    // Show/hide form fields based on payment type
    const paymentTypeSelect = document.getElementById('payment_type');
    const productFields = document.getElementById('product-fields');
    const otherFields = document.getElementById('other-fields');

    paymentTypeSelect.addEventListener('change', function () {
    const type = this.value;
    const productInputs = productFields.querySelectorAll('input');

    if (type === 'product') {
        productFields.style.display = 'block';
        otherFields.style.display = 'none';
        productInputs.forEach(input => input.setAttribute('required', ''));
    } else {
        productFields.style.display = 'none';
        otherFields.style.display = 'block';
        productInputs.forEach(input => input.removeAttribute('required'));
    }
});


    // Calculate selling price
    function calculateSellingPrice() {
        const baseCost = parseFloat(document.getElementById('base_cost').value) || 0;
        const transportation = parseFloat(document.getElementById('transportation').value) || 0;
        const carriage = parseFloat(document.getElementById('carriage').value) || 0;
        const quantity = parseFloat(document.getElementById('product_quantity').value) || 1;
        const profitMargin = parseFloat(document.getElementById('profit_margin').value) || 0;

        const totalCost = baseCost + transportation + carriage;

        if (totalCost > 0 && quantity > 0) {
            const costPerUnit = totalCost / quantity;
            const sellingPrice = costPerUnit * (1 + (profitMargin / 100));
            // document.getElementById('calculated_price').value = (Math.round(sellingPrice * 2) / 2).toFixed(2);
            function roundToNearestHalf(value) {
                return Math.ceil(value * 2) / 2;
            }
            document.getElementById('calculated_price').value = roundToNearestHalf(sellingPrice).toFixed(2);

        }
    }

    document.getElementById('base_cost').addEventListener('input', calculateSellingPrice);
    document.getElementById('transportation').addEventListener('input', calculateSellingPrice);
    document.getElementById('carriage').addEventListener('input', calculateSellingPrice);
    document.getElementById('product_quantity').addEventListener('input', calculateSellingPrice);
    document.getElementById('profit_margin').addEventListener('input', calculateSellingPrice);

    // Submit payment form
    document.getElementById('payment-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    
    const type = paymentTypeSelect.value;
    const formData = { payment_type: type };
    const editId = document.getElementById('edit_payment_id').value;
    const method = editId ? 'PUT' : 'POST';
    const endpoint = editId ? `/api/payments/${editId}` : '/api/payments';


    try {
        if (type === 'product') {
            const productName = document.getElementById('product_name').value.trim();
            const quantity = parseFloat(document.getElementById('product_quantity').value);
            const baseCost = parseFloat(document.getElementById('base_cost').value);
            const transportation = parseFloat(document.getElementById('transportation').value);
            const carriage = parseFloat(document.getElementById('carriage').value);
            const profitMargin = parseFloat(document.getElementById('profit_margin').value);
            const totalCost = baseCost + transportation + carriage;
            const costPerUnit = totalCost / quantity;
            const sellingPrice = costPerUnit * (1 + (profitMargin / 100));

            if (!productName || isNaN(quantity) || isNaN(profitMargin)) {
                throw new Error('Fill all product fields with valid values');
            }

            Object.assign(formData, {
                product_name: productName,
                quantity: quantity,
                base_cost: baseCost,
                transportation: transportation,
                carriage: carriage,
                profit_margin: profitMargin,
                calculated_price: sellingPrice
                
            });
        } else {
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim();

            if (isNaN(amount) || amount <= 0) {
                throw new Error('Enter a valid payment amount');
            }

            Object.assign(formData, {
                amount: amount,
                description: description
            });
        }
            // const editId = document.getElementById('edit_payment_id').value;
            // const method = editId ? 'PUT' : 'POST';
            // const endpoint = editId ? `/api/payments/${editId}` : '/api/payments';

            const response = await fetch(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });


            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to save payment');
            }

            const payment = await response.json();
            const newRow = `
                <tr>
                    <td>${payment.date}</td>
                    <td>${payment.payment_type}</td>
                    <td>${payment.description}</td>
                    <td>${parseFloat(payment.amount).toFixed(2)}</td>
                </tr>
            `;
            document.querySelector('.payment-table tbody').insertAdjacentHTML('afterbegin', newRow);

            this.reset();
            productFields.style.display = 'none';
            otherFields.style.display = 'none';
            alert('Payment recorded successfully!');
            this.reset();
            document.getElementById('edit_payment_id').value = '';
            document.querySelector('.submit-btn').textContent = 'Record Payment';


        } catch (err) {
            alert(`Error: ${err.message}`);
            console.error(err);
        }
    });

    function deletePayment(id) {
    if (confirm("Are you sure you want to delete this payment?")) {
        fetch(`/api/payments/${id}`, {
            method: 'DELETE',
            headers: { 'Accept': 'application/json' }
        }).then(response => {
            if (response.ok) {
                alert('Payment deleted');
                location.reload(); // Refresh to reflect change
            } else {
                alert('Failed to delete payment');
            }
        });
    }
}

    function editPayment(paymentId) {
    fetch(`/api/payments/${paymentId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('payment_type').value = data.payment_type;
            const evt = new Event('change');  // Trigger type change visibility
            document.getElementById('payment_type').dispatchEvent(evt);

            if (data.payment_type === 'product') {
                document.getElementById('product_name').value = data.product_name;
                document.getElementById('product_quantity').value = data.quantity;
                document.getElementById('base_cost').value = data.base_cost;
                document.getElementById('transportation').value = data.transportation;
                document.getElementById('carriage').value = data.carriage;
                document.getElementById('profit_margin').value = data.profit_margin;
                document.getElementById('calculated_price').value = data.selling_price;
            } else {
                document.getElementById('amount').value = data.amount;
                document.getElementById('description').value = data.description;
            }

            document.getElementById('edit_payment_id').value = data.id;  // Track edit mode
            document.querySelector('.submit-btn').textContent = 'Update Payment';
        });
}


});
</script>

</body> 
</html>